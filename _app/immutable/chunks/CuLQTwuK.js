import{F as d}from"./CRlX8TpR.js";import{t as g}from"./sLrbt0Jw.js";import{u,f as y}from"./Da9-NLMC.js";import{createDialog as h}from"./BrKf4TUx.js";import{a as f}from"./BB3eo-aZ.js";import{openQueuePopover as w}from"./Ph2BXYvY.js";import{resultFileTypes as v}from"./EMYObbtG.js";const k=e=>{const t=e.split("/")[0];if(v.includes(t))return t},$=e=>{const t=u(),r=k(e.type),p=[{worker:"remux",workerId:u(),parentId:t,workerArgs:{files:[e],ffargs:["-c","copy","-map","0"],output:{type:e.type,format:e.name.split(".").pop()}}}];r&&(f({id:t,state:"waiting",pipeline:p,filename:e.name,mimeType:e.type,mediaType:r}),w())},x=e=>{const t=["-c:v","copy"];return["merge","remux"].includes(e.type)?t.push("-c:a","copy"):e.type==="mute"&&t.push("-an"),e.output.subtitles&&t.push("-c:s",e.output.filename.endsWith(".mp4")?"mov_text":"webvtt"),t.push(...e.output.metadata?y(e.output.metadata):[]),t},b=e=>{if(!e.audio)return;const t=[];e.audio.cover&&e.audio.format==="mp3"?t.push("-map","0","-map","1",...e.audio.cropCover?["-c:v","mjpeg","-vf","scale=-1:720,crop=720:720"]:["-c:v","copy"]):t.push("-vn"),t.push(...e.audio.copy?["-c:a","copy"]:["-b:a",`${e.audio.bitrate}k`],...e.output.metadata?y(e.output.metadata):[]),e.audio.format==="mp3"&&e.audio.bitrate==="8"&&t.push("-ar","12000"),e.audio.format==="opus"&&t.push("-vbr","off");const r=e.audio.format==="m4a"?"ipod":e.audio.format;return t.push("-f",r),t},I=()=>["-vf","scale=-1:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse","-loop","0","-f","gif"],n=e=>h({id:"pipeline-error",type:"small",meowbalt:"error",buttons:[{text:d(g)("button.gotit"),main:!0,action:()=>{}}],bodyText:d(g)(`error.${e}`)}),j=(e,t,r)=>{var c,l;if(!((c=e.output)!=null&&c.filename)||!((l=e.output)!=null&&l.type))return n("pipeline.missing_response_data");const p=r||u(),s=[],a=e.tunnel.reverse();for(const o of a)s.push({worker:"fetch",workerId:u(),parentId:p,workerArgs:{url:o}});if(e.type!=="proxy"){let o,i;if(["merge","mute","remux"].includes(e.type))i="remux",o=x(e);else if(e.type==="audio"){const m=b(e);if(!m)return n("pipeline.missing_response_data");i="encode",o=m}else if(e.type==="gif")i="encode",o=I();else return console.error("unknown work type: "+e.type),n("pipeline.missing_response_data");s.push({worker:i,workerId:u(),parentId:p,dependsOn:s.map(m=>m.workerId),workerArgs:{files:[],ffargs:o,output:{type:e.output.type,format:e.output.filename.split(".").pop()}}})}f({id:p,state:"waiting",pipeline:s,canRetry:!0,originalRequest:t,filename:e.output.filename,mimeType:e.output.type,mediaType:k(e.output.type)||"file"}),w()},q=(e,t)=>{var p;if(e.state==="done"||e.state==="error")return 1;if(e.state==="waiting")return 0;let r=0;for(const s of e.pipeline)if(e.pipelineResults[s.workerId])r+=1;else{const a=t[s.workerId];r+=(((p=a==null?void 0:a.progress)==null?void 0:p.percentage)||0)/100}return r/e.pipeline.length};export{$ as createRemuxPipeline,j as createSavePipeline,k as getMediaType,q as getProgress};
//# sourceMappingURL=CuLQTwuK.js.map
