import{az as S,G as C,F,r as M}from"./CRlX8TpR.js";import{d as x}from"./Hp68DFFA.js";import{clearFileStorage as Q,removeFromFileStorage as w}from"./De4dRPKL.js";function E(e){return new Worker("/_app/immutable/workers/ffmpeg-CxP6edDa.js",{name:e==null?void 0:e.name})}const d=C({}),G=S(d);function $(e,r){d.update(n=>(n[e]=r,n))}function y(e){d.update(r=>(delete r[e],r))}function O(e,r){d.update(n=>(n[e].progress=r,n))}function B(){d.set({})}let h=0;const T=async(e,r,n,t,s,o,i,m=!1)=>{const c=new E;m&&(h=0);let v=0;const u=setInterval(async()=>{if(v++,v===10)return h++,h<=10?(f(c,b,u),await T(e,r,n,t,s,o,i)):(f(c,b,u),p(r,e,"queue.worker_didnt_start"))},500),b=W.subscribe(k=>{k[r]||f(c,b,u)});c.postMessage({cobaltFFmpegWorker:{variant:o,files:n,args:t,output:s,yesthreads:i}}),c.onerror=k=>(console.error("ffmpeg worker crashed:",k),f(c,b,u),p(r,e,"queue.generic_error"));let _=null;c.onmessage=k=>{const l=k.data.cobaltFFmpegWorker;if(l){if(clearInterval(u),l.progress&&(l.progress.duration&&(_=l.progress.duration),O(e,{percentage:_?l.progress.durationProcessed/_*100:0,size:l.progress.size})),l.render)return f(c,b,u),P(r,e,l.render);if(l.error)return f(c,b,u),p(r,e,l.error)}}};function H(e){return new Worker("/_app/immutable/workers/fetch-Ds-eyMrd.js",{name:e==null?void 0:e.name})}const J=async(e,r,n)=>{const t=new H,s=W.subscribe(o=>{o[r]||f(t,s)});t.postMessage({cobaltFetchWorker:{url:n}}),t.onmessage=o=>{const i=o.data.cobaltFetchWorker;if(i){if(i.progress&&O(e,{percentage:i.progress,size:i.size}),i.result)return f(t,s),P(r,e,i.result);if(i.error)return f(t,s),p(r,e,i.error)}}},f=(e,r,n)=>{r(),e.terminate(),n&&clearInterval(n)},z=async({worker:e,workerId:r,dependsOn:n,parentId:t,workerArgs:s})=>{let o=[];switch(e){case"remux":case"encode":{s.files&&(o=s.files);const i=F(W)[t];if((i==null?void 0:i.state)==="running"&&n)for(const m of n){const c=i.pipelineResults[m];if(!c)return p(t,m,"queue.ffmpeg.no_args");o.push(c)}o.length>0&&s.ffargs&&s.output?await T(r,t,o,s.ffargs,s.output,e,x.supports.multithreading,!0):p(t,r,"queue.ffmpeg.no_args");break}case"fetch":await J(r,t,s.url);break}},X=Object.freeze(Object.defineProperty({__proto__:null,killWorker:f,startWorker:z},Symbol.toStringTag,{value:"Module"})),R=e=>{$(e.workerId,{type:e.worker,parentId:e.parentId}),L(e.parentId),z(e)},g=()=>{var n;const e=F(W),r=F(G);for(const t of Object.values(e))if(t.state==="running"){const s=t.pipeline[t.pipeline.length-1];if(Object.keys(t.pipelineResults).length===t.pipeline.length){const o=t.pipelineResults[s.workerId];delete t.pipelineResults[s.workerId],o?K(t.id,o):p(t.id,s.workerId,"queue.no_final_file");continue}for(const o of t.pipeline){if(t.pipelineResults[o.workerId]||r[o.workerId])continue;if((n=o.dependsOn)==null?void 0:n.some(m=>!t.pipelineResults[m]))break;R(o)}break}else if(t.state==="waiting"&&t.pipeline.length>0&&Object.keys(r).length===0){for(const s of Object.values(e))if(s.state==="running")return;R(t.pipeline[0]);break}},Y=Object.freeze(Object.defineProperty({__proto__:null,schedule:g},Symbol.toStringTag,{value:"Module"})),j=e=>{if(e.state==="running")for(const[r,n]of Object.entries(e.pipelineResults))w(n.name),delete e.pipelineResults[r];else e.state==="done"&&w(e.resultFile.name);return e};let a;const W=M({},(e,r)=>{a=r});function Z(e){a(r=>(r[e.id]=e,r)),g()}function p(e,r,n){a(t=>(t[e]&&(t[e]=j(t[e]),t[e]={...t[e],state:"error",errorCode:n}),t)),y(r),g()}function K(e,r){a(n=>(n[e]&&(n[e]=j(n[e]),n[e]={...n[e],state:"done",resultFile:r}),n)),g()}function P(e,r,n){a(t=>{const s=t[e];return s&&s.state==="running"&&(s.pipelineResults[r]=n),t}),y(r),g()}function L(e){a(r=>{const n=r[e];return n&&(n.state="running",n.pipelineResults??(n.pipelineResults={})),r}),g()}function A(e){a(r=>{const n=r[e];for(const t of n.pipeline)y(t.workerId);return j(n),delete r[e],r}),g()}function D(){a(()=>({})),B(),Q()}export{Z as a,G as b,D as c,X as d,W as q,A as r,Y as s};
//# sourceMappingURL=BB3eo-aZ.js.map
